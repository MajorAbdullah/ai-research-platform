<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenAI Research Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div x-data="researchApp()" class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">OpenAI Research Interface</h1>
            <p class="text-gray-600">Conduct comprehensive research using advanced AI models</p>
        </div>

        <!-- Previous Results Section - Always Visible -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-900">ðŸ“Š Previous Research Results</h2>
                <button 
                    @click="showPreviousResults = !showPreviousResults"
                    class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                    <span x-show="!showPreviousResults">Show All</span>
                    <span x-show="showPreviousResults">Hide</span>
                </button>
            </div>
            
            <!-- Summary Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div class="bg-blue-50 p-3 rounded-lg">
                    <div class="text-2xl font-bold text-blue-600" x-text="previousResults.length"></div>
                    <div class="text-sm text-blue-800">Total Results</div>
                </div>
                <div class="bg-green-50 p-3 rounded-lg">
                    <div class="text-2xl font-bold text-green-600" x-text="getTotalCitations()"></div>
                    <div class="text-sm text-green-800">Total Citations</div>
                </div>
                <div class="bg-purple-50 p-3 rounded-lg">
                    <div class="text-2xl font-bold text-purple-600" x-text="getTotalWords()"></div>
                    <div class="text-sm text-purple-800">Total Words</div>
                </div>
                <div class="bg-orange-50 p-3 rounded-lg">
                    <div class="text-2xl font-bold text-orange-600" x-text="getAvgProcessingTime()"></div>
                    <div class="text-sm text-orange-800">Avg Time</div>
                </div>
            </div>

            <!-- Previous Results List (collapsible) -->
            <div x-show="showPreviousResults" x-transition class="space-y-3">
                <template x-if="previousResults.length === 0">
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-4">ðŸ”¬</div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No Research History Yet</h3>
                        <p class="text-sm">Your completed research will appear here. Start by submitting your first research query below!</p>
                    </div>
                </template>
                <template x-for="result in previousResults" :key="result.id">
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <h3 class="font-medium text-gray-900 mb-1" x-text="result.query"></h3>
                                <div class="flex items-center space-x-4 text-sm text-gray-600">
                                    <span class="flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <span x-text="result.research_type"></span>
                                    </span>
                                    <span class="flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span x-text="result.processing_time"></span>
                                    </span>
                                    <span class="flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <span x-text="result.citations + ' citations'"></span>
                                    </span>
                                    <span class="flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                        <span x-text="result.word_count + ' words'"></span>
                                    </span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2 ml-4">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800" 
                                      x-text="result.model"></span>
                                <button 
                                    @click="viewPreviousResult(result)"
                                    class="text-blue-600 hover:text-blue-800 text-sm">
                                    View
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Model Selection & Research Form -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <form @submit.prevent="submitResearch()" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Research Model</label>
                    <select x-model="selectedModel" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <template x-for="model in models" :key="model.id">
                            <option :value="model.id" x-text="model.name"></option>
                        </template>
                    </select>
                    <div x-show="selectedModelInfo" class="mt-2 p-3 bg-blue-50 rounded-md">
                        <p class="text-sm text-blue-800" x-text="selectedModelInfo?.description"></p>
                        <div class="mt-1 text-xs text-blue-600">
                            <span x-text="'Best for: ' + selectedModelInfo?.best_for"></span> |
                            <span x-text="'Cost: ' + selectedModelInfo?.cost"></span> |
                            <span x-text="'Speed: ' + selectedModelInfo?.speed"></span>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Research Type</label>
                    <select x-model="researchType" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="custom">Custom Research</option>
                        <option value="validation">Idea Validation</option>
                        <option value="market">Market Research</option>
                        <option value="financial">Financial Analysis</option>
                        <option value="comprehensive">Comprehensive Analysis (All Three)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Research Query</label>
                    <textarea 
                        x-model="query" 
                        rows="4" 
                        class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Enter your research question or startup idea...">
                    </textarea>
                </div>

                <!-- Citation Control -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Number of Citations/Sources</label>
                    <div class="flex items-center space-x-4">
                        <input 
                            type="range" 
                            x-model="maxCitations" 
                            min="5" 
                            max="100" 
                            step="5"
                            class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <div class="flex items-center space-x-2">
                            <input 
                                type="number" 
                                x-model="maxCitations" 
                                min="5" 
                                max="100" 
                                class="w-16 px-2 py-1 border border-gray-300 rounded text-center text-sm">
                            <span class="text-sm text-gray-600">sources</span>
                        </div>
                    </div>
                    <div class="mt-1 text-xs text-gray-500">
                        <span x-show="maxCitations <= 10">Quick overview with key sources</span>
                        <span x-show="maxCitations > 10 && maxCitations <= 25">Balanced research with good coverage</span>
                        <span x-show="maxCitations > 25 && maxCitations <= 50">In-depth research with extensive references</span>
                        <span x-show="maxCitations > 50">Comprehensive research with maximum validation</span>
                    </div>
                </div>

                <div class="flex items-center">
                    <input type="checkbox" x-model="enrichPrompt" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label class="ml-2 block text-sm text-gray-700">Enrich prompt automatically (recommended)</label>
                </div>

                <button 
                    type="submit" 
                    :disabled="!query || isLoading"
                    class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span x-show="!isLoading">Start Research</span>
                    <span x-show="isLoading">Starting Research...</span>
                </button>
            </form>
        </div>

        <!-- Research Status -->
        <div x-show="currentTask" class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h3 class="text-lg font-semibold mb-4">Research Progress</h3>
            
            <!-- Progress Steps -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium">Progress</span>
                    <span class="text-sm text-gray-600" x-text="getProgressPercentage() + '%'"></span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-1000 ease-out" 
                         :style="'width: ' + getProgressPercentage() + '%'"></div>
                </div>
            </div>

            <!-- Step Indicators -->
            <div class="space-y-3 mb-4">
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center" 
                         :class="getStepClass(1)">
                        <span x-show="getStepNumber() > 1" class="text-white text-sm">âœ“</span>
                        <span x-show="getStepNumber() === 1" class="w-3 h-3 bg-white rounded-full animate-pulse"></span>
                        <span x-show="getStepNumber() < 1" class="text-gray-400 text-sm">1</span>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium" :class="getStepNumber() >= 1 ? 'text-gray-900' : 'text-gray-400'">
                            Initialize Research
                        </p>
                        <p class="text-xs text-gray-500">Setting up AI models and preparing query</p>
                    </div>
                </div>

                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center" 
                         :class="getStepClass(2)">
                        <span x-show="getStepNumber() > 2" class="text-white text-sm">âœ“</span>
                        <span x-show="getStepNumber() === 2" class="w-3 h-3 bg-white rounded-full animate-pulse"></span>
                        <span x-show="getStepNumber() < 2" class="text-gray-400 text-sm">2</span>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium" :class="getStepNumber() >= 2 ? 'text-gray-900' : 'text-gray-400'">
                            Data Collection
                        </p>
                        <p class="text-xs text-gray-500">Gathering information from multiple sources</p>
                    </div>
                </div>

                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center" 
                         :class="getStepClass(3)">
                        <span x-show="getStepNumber() > 3" class="text-white text-sm">âœ“</span>
                        <span x-show="getStepNumber() === 3" class="w-3 h-3 bg-white rounded-full animate-pulse"></span>
                        <span x-show="getStepNumber() < 3" class="text-gray-400 text-sm">3</span>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium" :class="getStepNumber() >= 3 ? 'text-gray-900' : 'text-gray-400'">
                            Analysis & Processing
                        </p>
                        <p class="text-xs text-gray-500">AI analysis and report generation</p>
                    </div>
                </div>

                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center" 
                         :class="getStepClass(4)">
                        <span x-show="getStepNumber() > 4" class="text-white text-sm">âœ“</span>
                        <span x-show="getStepNumber() === 4" class="w-3 h-3 bg-white rounded-full animate-pulse"></span>
                        <span x-show="getStepNumber() < 4" class="text-gray-400 text-sm">4</span>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium" :class="getStepNumber() >= 4 ? 'text-gray-900' : 'text-gray-400'">
                            Final Report
                        </p>
                        <p class="text-xs text-gray-500">Formatting and finalizing results</p>
                    </div>
                </div>
            </div>

            <!-- Current Status -->
            <div class="bg-blue-50 rounded-lg p-4">
                <div class="flex items-center space-x-2">
                    <div x-show="currentTask?.status === 'running'" class="flex-shrink-0">
                        <div class="animate-spin w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full"></div>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-blue-900" x-text="currentTask?.progress || 'Processing...'"></p>
                        <p class="text-xs text-blue-700">
                            <span x-text="'Model: ' + (currentTask?.model || 'Unknown')"></span> â€¢ 
                            <span x-text="'Type: ' + (currentTask?.research_type || 'custom')"></span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Research Results -->
        <div x-show="results.length > 0" class="space-y-6">
            <h2 class="text-2xl font-bold text-gray-900">Research Results</h2>
            <template x-for="result in results" :key="result.task_id">
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <!-- Result Header -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 border-b">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-lg font-semibold text-gray-900" x-text="result.query"></h3>
                            <div class="flex items-center space-x-2">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800" 
                                      x-text="result.model"></span>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800" 
                                      x-text="result.research_type"></span>
                            </div>
                        </div>
                        
                        <!-- Metadata Row -->
                        <div class="flex items-center justify-between text-sm text-gray-600">
                            <div class="flex items-center space-x-4">
                                <span x-show="result.result?.processing_time_formatted" class="flex items-center space-x-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span x-text="result.result.processing_time_formatted"></span>
                                </span>
                                <span x-show="getCitationCount(result)" class="flex items-center space-x-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <span x-text="getCitationCount(result) + ' citations'"></span>
                                </span>
                                <span x-show="getWordCount(result)" class="flex items-center space-x-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <span x-text="getWordCount(result) + ' words'"></span>
                                </span>
                            </div>
                            <span class="text-xs" x-text="'Completed: ' + new Date(result.completed_at).toLocaleString()"></span>
                        </div>
                    </div>

                    <!-- Result Content -->
                    <div class="p-6">
                        <div x-show="result.status === 'completed' && result.result">
                            <!-- Comprehensive Research Display -->
                            <div x-show="result.research_type === 'comprehensive'" class="space-y-6">
                                <template x-for="(section, sectionName) in result.result?.sections || {}" :key="sectionName">
                                    <div class="border border-gray-200 rounded-lg">
                                        <div class="bg-gray-50 px-4 py-3 border-b">
                                            <h4 class="font-medium text-gray-900 capitalize" x-text="sectionName.replace('_', ' ')"></h4>
                                            <div class="flex items-center space-x-3 text-sm text-gray-600 mt-1">
                                                <span x-show="section.citations" x-text="section.citations + ' citations'"></span>
                                                <span x-show="section.word_count" x-text="section.word_count + ' words'"></span>
                                            </div>
                                        </div>
                                        <div class="p-4 max-h-64 overflow-y-auto">
                                            <div class="prose prose-sm max-w-none" x-html="formatMarkdown(section.formatted_output || section.output)"></div>
                                        </div>
                                    </div>
                                </template>
                            </div>

                            <!-- Single Research Display -->
                            <div x-show="result.research_type !== 'comprehensive'" class="max-h-96 overflow-y-auto">
                                <div class="prose prose-sm max-w-none" x-html="formatMarkdown(result.result?.formatted_output || result.result?.output || formatResult(result.result))"></div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="mt-6 flex space-x-3">
                                <button 
                                    @click="downloadResult(result)"
                                    class="inline-flex items-center px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    Download Report
                                </button>
                                <button 
                                    @click="copyResult(result)"
                                    class="inline-flex items-center px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                    </svg>
                                    Copy to Clipboard
                                </button>
                                <button 
                                    @click="openDashboard(result)"
                                    class="inline-flex items-center px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    Open Integrated Dashboard
                                </button>
                            </div>
                        </div>

                        <div x-show="result.status === 'failed'" class="bg-red-50 border border-red-200 rounded-md p-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-red-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L5.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                                <p class="text-red-800 text-sm font-medium">Research Failed</p>
                            </div>
                            <p class="text-red-700 text-sm mt-1" x-text="result.error"></p>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <script>
        function researchApp() {
            return {
                models: [],
                selectedModel: 'o3-deep-research',
                researchType: 'custom',
                query: '',
                enrichPrompt: true,
                maxCitations: 15,
                isLoading: false,
                currentTask: null,
                results: [],
                previousResults: [],
                showPreviousResults: false,

                async init() {
                    await this.loadModels();
                    await this.loadPreviousResults();
                    this.checkPendingTasks();
                    // Poll for updates every 5 seconds
                    setInterval(() => this.checkPendingTasks(), 5000);
                },

                get selectedModelInfo() {
                    return this.models.find(m => m.id === this.selectedModel);
                },

                async loadModels() {
                    try {
                        console.log('Loading models...');
                        const response = await fetch('/api/models');
                        console.log('Response status:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        const data = await response.json();
                        console.log('Models data received:', data);
                        this.models = Object.entries(data).map(([id, info]) => ({
                            id,
                            name: info.name,
                            description: info.description,
                            best_for: info.best_for,
                            cost: info.cost,
                            speed: info.speed
                        }));
                        console.log('Models array:', this.models);
                    } catch (error) {
                        console.error('Failed to load models:', error);
                        // Fallback models if API fails
                        this.models = [
                            {
                                id: 'o3-deep-research',
                                name: 'O3 Deep Research',
                                description: 'Most comprehensive research model with advanced reasoning capabilities',
                                best_for: 'Complex analysis, detailed reports, comprehensive research',
                                cost: 'Higher',
                                speed: 'Slower'
                            },
                            {
                                id: 'o4-mini-deep-research',
                                name: 'O4 Mini Deep Research',
                                description: 'Faster, cost-effective research model for quicker insights',
                                best_for: 'Quick research, initial exploration, cost-sensitive tasks',
                                cost: 'Lower',
                                speed: 'Faster'
                            }
                        ];
                    }
                },

                async loadPreviousResults() {
                    try {
                        const response = await fetch('/api/research/previous');
                        if (response.ok) {
                            this.previousResults = await response.json();
                        }
                    } catch (error) {
                        console.error('Error loading previous results:', error);
                    }
                },

                getTotalCitations() {
                    return this.previousResults.reduce((sum, result) => sum + (result.citations || 0), 0);
                },

                getTotalWords() {
                    return this.previousResults.reduce((sum, result) => sum + (result.word_count || 0), 0);
                },

                getAvgProcessingTime() {
                    if (this.previousResults.length === 0) return '0s';
                    const totalSeconds = this.previousResults.reduce((sum, result) => {
                        const time = result.processing_time;
                        if (time.includes('m')) {
                            const parts = time.split('m');
                            const minutes = parseInt(parts[0]) || 0;
                            const seconds = parseInt(parts[1]) || 0;
                            return sum + (minutes * 60 + seconds);
                        }
                        return sum + (parseInt(time) || 0);
                    }, 0);
                    const avgSeconds = Math.round(totalSeconds / this.previousResults.length);
                    if (avgSeconds >= 60) {
                        const minutes = Math.floor(avgSeconds / 60);
                        const seconds = avgSeconds % 60;
                        return `${minutes}m${seconds}s`;
                    }
                    return `${avgSeconds}s`;
                },

                viewPreviousResult(result) {
                    // Add to current results view
                    if (!this.results.find(r => r.task_id === result.id)) {
                        this.results.unshift({
                            task_id: result.id,
                            query: result.query,
                            model: result.model,
                            research_type: result.research_type,
                            status: 'completed',
                            completed_at: result.completed_at,
                            result: {
                                formatted_output: result.document_path ? 'Loading from file...' : result.content,
                                processing_time_formatted: result.processing_time,
                                citations: result.citations,
                                word_count: result.word_count
                            }
                        });
                    }
                },

                async submitResearch() {
                    if (!this.query.trim()) return;

                    this.isLoading = true;
                    try {
                        const response = await fetch('/api/research', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                query: this.query,
                                model: this.selectedModel,
                                research_type: this.researchType,
                                enrich_prompt: this.enrichPrompt,
                                max_citations: parseInt(this.maxCitations)
                            })
                        });

                        if (response.ok) {
                            const task = await response.json();
                            this.currentTask = task;
                            this.query = '';
                        } else {
                            alert('Failed to start research');
                        }
                    } catch (error) {
                        console.error('Error submitting research:', error);
                        alert('Error submitting research');
                    } finally {
                        this.isLoading = false;
                    }
                },

                async checkPendingTasks() {
                    if (this.currentTask && (this.currentTask.status === 'pending' || this.currentTask.status === 'running')) {
                        try {
                            // For comprehensive research, check progressive results
                            if (this.currentTask.research_type === 'comprehensive') {
                                const progressResponse = await fetch(`/api/research/${this.currentTask.task_id}/progressive`);
                                if (progressResponse.ok) {
                                    const progressData = await progressResponse.json();
                                    this.currentTask = progressData;
                                    
                                    // If there are partial results, add them to results display
                                    if (progressData.partial_result && progressData.partial_result.sections) {
                                        this.updateProgressiveResults(progressData);
                                    }
                                }
                            }
                            
                            // Check regular status
                            const response = await fetch(`/api/research/${this.currentTask.task_id}/status`);
                            if (response.ok) {
                                const status = await response.json();
                                this.currentTask = {...this.currentTask, ...status};

                                if (status.status === 'completed' || status.status === 'failed') {
                                    await this.loadResults();
                                    await this.loadPreviousResults(); // Refresh previous results
                                    this.currentTask = null;
                                }
                            }
                        } catch (error) {
                            console.error('Error checking task status:', error);
                        }
                    }
                },

                updateProgressiveResults(progressData) {
                    // Find existing progressive result or create new one
                    let existingIndex = this.results.findIndex(r => r.task_id === progressData.task_id);
                    
                    const progressiveResult = {
                        task_id: progressData.task_id,
                        query: this.currentTask.query,
                        model: this.currentTask.model,
                        research_type: 'comprehensive',
                        status: 'in-progress',
                        created_at: this.currentTask.created_at,
                        result: progressData.partial_result
                    };
                    
                    if (existingIndex >= 0) {
                        // Update existing progressive result
                        this.results[existingIndex] = progressiveResult;
                    } else {
                        // Add new progressive result
                        this.results.unshift(progressiveResult);
                    }
                },

                async loadResults() {
                    try {
                        const response = await fetch('/api/research/results');
                        if (response.ok) {
                            this.results = await response.json();
                        }
                    } catch (error) {
                        console.error('Error loading results:', error);
                    }
                },

                getProgressPercentage() {
                    if (!this.currentTask) return 0;
                    const status = this.currentTask.status;
                    const progress = this.currentTask.progress || '';
                    
                    if (status === 'pending') return 10;
                    if (status === 'running') {
                        if (progress.includes('Initializing')) return 25;
                        if (progress.includes('collecting') || progress.includes('Conducting') || progress.includes('Performing')) return 50;
                        if (progress.includes('Processing') || progress.includes('analysis')) return 75;
                        if (progress.includes('Finalizing')) return 90;
                        return 60;
                    }
                    if (status === 'completed') return 100;
                    return 0;
                },

                getStepNumber() {
                    if (!this.currentTask) return 0;
                    const progress = this.currentTask.progress || '';
                    
                    if (progress.includes('Initializing')) return 1;
                    if (progress.includes('collecting') || progress.includes('Conducting') || progress.includes('Performing')) return 2;
                    if (progress.includes('Processing') || progress.includes('analysis')) return 3;
                    if (progress.includes('Finalizing') || this.currentTask.status === 'completed') return 4;
                    return 1;
                },

                getStepClass(stepNumber) {
                    const current = this.getStepNumber();
                    if (current > stepNumber) return 'bg-green-500';
                    if (current === stepNumber) return 'bg-blue-500';
                    return 'bg-gray-300';
                },

                getCitationCount(result) {
                    if (result.research_type === 'comprehensive') {
                        return result.result?.total_citations || 0;
                    }
                    return result.result?.citations || 0;
                },

                getWordCount(result) {
                    if (result.research_type === 'comprehensive') {
                        return result.result?.total_words || 0;
                    }
                    return result.result?.word_count || 0;
                },

                formatMarkdown(text) {
                    if (!text) return '';
                    
                    // Simple markdown to HTML conversion
                    return text
                        .replace(/### (.*?)\n/g, '<h3 class="text-lg font-semibold mt-4 mb-2">$1</h3>')
                        .replace(/## (.*?)\n/g, '<h2 class="text-xl font-bold mt-6 mb-3">$1</h2>')
                        .replace(/# (.*?)\n/g, '<h1 class="text-2xl font-bold mt-8 mb-4">$1</h1>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="text-blue-600 underline" target="_blank">$1</a>')
                        .replace(/\n- (.*?)(?=\n|$)/g, '\n<li class="ml-4">$1</li>')
                        .replace(/(<li.*?>.*?<\/li>)/gs, '<ul class="list-disc ml-6 mb-2">$1</ul>')
                        .replace(/\n\n/g, '</p><p class="mb-3">')
                        .replace(/^/, '<p class="mb-3">')
                        .replace(/$/, '</p>');
                },

                formatResult(result) {
                    if (typeof result === 'string') return result;
                    if (result?.formatted_output) return result.formatted_output;
                    if (result?.output) return result.output;
                    return JSON.stringify(result, null, 2);
                },

                downloadResult(result) {
                    let content = '';
                    
                    if (result.research_type === 'comprehensive') {
                        content = `# Research Report: ${result.query}\n\n`;
                        content += `**Model:** ${result.model}\n`;
                        content += `**Processing Time:** ${result.result?.processing_time_formatted}\n`;
                        content += `**Total Citations:** ${this.getCitationCount(result)}\n`;
                        content += `**Total Words:** ${this.getWordCount(result)}\n\n`;
                        content += `---\n\n`;
                        
                        for (const [sectionName, section] of Object.entries(result.result?.sections || {})) {
                            content += `# ${sectionName.replace('_', ' ').toUpperCase()}\n\n`;
                            content += section.formatted_output || section.output || '';
                            content += `\n\n---\n\n`;
                        }
                    } else {
                        content = `# Research Report: ${result.query}\n\n`;
                        content += `**Model:** ${result.model}\n`;
                        content += `**Type:** ${result.research_type}\n`;
                        content += `**Processing Time:** ${result.result?.processing_time_formatted}\n`;
                        content += `**Citations:** ${this.getCitationCount(result)}\n`;
                        content += `**Words:** ${this.getWordCount(result)}\n\n`;
                        content += `---\n\n`;
                        content += this.formatResult(result.result);
                    }
                    
                    const blob = new Blob([content], { type: 'text/markdown' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `research_${result.query.substring(0, 30).replace(/[^a-zA-Z0-9]/g, '_')}.md`;
                    a.click();
                    URL.revokeObjectURL(url);
                },

                async copyResult(result) {
                    const content = this.formatResult(result.result);
                    try {
                        await navigator.clipboard.writeText(content);
                        alert('Result copied to clipboard!');
                    } catch (error) {
                        console.error('Failed to copy to clipboard:', error);
                    }
                },

                openDashboard(result) {
                    // Store result data for dashboard
                    localStorage.setItem('dashboardData', JSON.stringify(result));
                    // Open React dashboard in new tab
                    window.open('http://localhost:8080', '_blank');
                }
            }
        }
    </script>
</body>
</html>
